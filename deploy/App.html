<!DOCTYPE html>
<html>
<head>
    <title>snapshots-per-month</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{months:"6"}},launch:function(){var that=this;that.months=[];var date=new Date;for(console.log("months",that.getSetting("months")),x=0;parseInt(that.getSetting("months"))>x;x++){var firstDay=new Date(date.getFullYear(),date.getMonth()-x,1),lastDay=new Date(date.getFullYear(),date.getMonth()-x+1,0);that.months.push({label:firstDay.getFullYear()+"-"+firstDay.toLocaleString("en-us",{month:"long"}),first:firstDay.toISOString().substring(0,10),last:lastDay.toISOString().substring(0,10)})}that.months.reverse(),console.log("months",that.months),that.createChart()},createChart:function(projects){var that=this,configs=_.map(that.months,function(m){return{find:{_ProjectHierarchy:that.getContext().getProject().ObjectID,$and:[{_ValidFrom:{$gte:m.first}},{_ValidFrom:{$lte:m.last}}]},fetch:["_ValidFrom","_TypeHierarchy"],hydrate:["_TypeHierarchy"]}});async.map(configs,that.snapshotQuery,function(err,results){console.log(results),that.add(that.createExtChart(results))})},createExtChart:function(results){var that=this,data=_.map(results,function(data,i){return{month:that.months[i].label,count:data}}),chartStore=Ext.create("Ext.data.JsonStore",{fields:["month","count"],data:data}),chart=new Ext.chart.Chart({width:that.getWidth(),height:that.getHeight(),animate:!0,store:chartStore,shadow:!0,axes:[{type:"Numeric",position:"left",fields:["count"],label:{renderer:Ext.util.Format.numberRenderer("0,0")},title:"Count",grid:!0,minimum:0},{type:"Category",position:"bottom",fields:["month"],title:"Month",label:{rotate:{degrees:45}}}],series:[{type:"column",axis:"bottom",highlight:!0,xField:"month",yField:"count",label:{field:"count",display:"rotate"}}]});return chart},snapshotQuery:function(config,callback){Ext.create("Rally.data.lookback.SnapshotStore",{find:config.find,autoLoad:!0,limit:10,fetch:config.fetch,hydrate:config.hydrate,pageSize:10,listeners:{scope:this,load:function(store,snapshots,success){console.log("Loaded:"+snapshots.length," Snapshots."),console.log("Store",store),callback(null,store.totalCount)}}})},getSettingsFields:function(){var me=this;return[{name:"months",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"# Months",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:"The number of months to report on."}]}});

            Rally.launchApp('CustomApp', {
                name:"snapshots-per-month",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
